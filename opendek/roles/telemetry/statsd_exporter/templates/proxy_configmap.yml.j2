# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2021-2022 Intel Corporation

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ _proxy_cm_name }}
  namespace: {{ telemetry_namespace }}
  labels:
    name: {{ _proxy_cm_name }}
data:
  nginx.conf: |-
    worker_processes  1;
    pid /tmp/nginx.pid;

    events {
        worker_connections  1024;
    }

    http {
        include       mime.types;
        default_type  application/octet-stream;
        sendfile        on;
        keepalive_timeout  65;

        server {
            listen                 {{ _proxy_container.metrics_statsd_port }} ssl;
            server_name            {{ _proxy_server_name }};
            ssl_certificate        {{ _proxy_certs_dest }}/tls.crt;
            ssl_certificate_key    {{ _proxy_certs_dest }}/tls.key;
            ssl_client_certificate {{ _proxy_certs_dest }}/ca.crt;
            ssl_protocols          {{ _proxy_nginx_conf.protocols }};
            ssl_ciphers            {{ _proxy_nginx_conf.ciphers | join(':') }};
            ssl_verify_client      on;

            location /metrics {
                proxy_pass http://localhost:{{ _proxy_container.internal_statsd_port }};
                }
            }
    }
