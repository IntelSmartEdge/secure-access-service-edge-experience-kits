# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2020-2021 Intel Corporation

---

- name: check if Kubernetes Dashboard release already exists
  command: helm status kubernetes-dashboard --namespace "{{ _dashboard_namespace }}"
  failed_when: false
  register: get_release_dashboard
  changed_when: false

- name: install Kubernetes Dashboard
  block:
  - name: open port for Kubernetes Dashboard
    include_role:
      name: infrastructure/firewall_open_ports
    vars:
      fw_open_ports:
        - "{{ _dashboard_port }}/tcp"

  - name: create Kubernetes Dashboard directories
    file:
      name: "{{ item }}"
      state: directory
      mode: a=rx,u+w
    loop:
      - "{{ _dashboard_chart_dir }}"
      - "{{ _dashboard_chart_dir }}/templates"
    changed_when: true

  - name: download Kubernetes Dashboard chart
    get_url:
      url: "{{ _dashboard_chart_url }}/{{ item }}"
      dest: "{{ _dashboard_chart_dir }}/{{ item }}"
    register: result
    retries: "{{ number_of_retries }}"
    until: result is succeeded
    delay: "{{ retry_delay }}"
    loop: "{{ _dashboard_chart_files }}"

  - name: template values.yml to chart dir
    template:
      src: values.yml.j2
      dest: "{{ _dashboard_chart_dir }}/custom-values.yml"
      mode: preserve

  - name: copy clusterrole to templates dir
    copy:
      src: "{{ item }}"
      dest: "{{ _dashboard_chart_dir }}/templates"
      mode: preserve
    loop:
      - clusterrole.yml
      - clusterrolebinding.yml

  - name: download helm chart dependencies
    command: helm dependency update
    args:
      chdir: "{{ _dashboard_chart_dir }}"

  - name: install Kubernetes Dashboard
    command: helm install kubernetes-dashboard --namespace "{{ _dashboard_namespace }}" -f "{{ _dashboard_chart_dir }}"/custom-values.yml \
              "{{ _dashboard_chart_dir }}"
  when: get_release_dashboard.rc != 0
